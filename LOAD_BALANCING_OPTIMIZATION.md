# æ™ºèƒ½è´Ÿè½½å‡è¡¡ä¼˜åŒ–è¯´æ˜

## ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å°†åŸæœ‰çš„ç®€å•ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡å‡çº§ä¸ºæ™ºèƒ½è´Ÿè½½å‡è¡¡ç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

### ğŸš€ æ–°å¢åŠŸèƒ½

1. **èŠ‚ç‚¹å¥åº·ç›‘æ§**
   - å®æ—¶ç›‘æ§æ¯ä¸ªèŠ‚ç‚¹çš„å¥åº·çŠ¶æ€
   - è‡ªåŠ¨æ£€æµ‹èŠ‚ç‚¹æ•…éšœå’Œæ¢å¤
   - å®šæœŸå¥åº·æ£€æŸ¥ï¼ˆæ¯15ç§’ï¼‰

2. **è´Ÿè½½ç»Ÿè®¡**
   - è¯·æ±‚è®¡æ•°ã€æˆåŠŸç‡ã€é”™è¯¯ç‡ç»Ÿè®¡
   - å¹³å‡å“åº”æ—¶é—´ç›‘æ§
   - å®æ—¶è´Ÿè½½åˆ†æ•°è®¡ç®—

3. **æ™ºèƒ½èŠ‚ç‚¹é€‰æ‹©**
   - ä¼˜å…ˆé€‰æ‹©å¥åº·èŠ‚ç‚¹
   - åŸºäºè´Ÿè½½åˆ†æ•°é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹
   - è‡ªåŠ¨æ•…éšœè½¬ç§»

4. **æ€§èƒ½ç›‘æ§æ¥å£**
   - `/stats` æ¥å£æä¾›è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
   - å®æ—¶æŸ¥çœ‹å„èŠ‚ç‚¹è´Ÿè½½æƒ…å†µ

## æŠ€æœ¯å®ç°

### 1. èŠ‚ç‚¹ç»Ÿè®¡ç»“æ„ä½“

```cpp
struct NodeStats {
    atomic<int> request_count{0};           // è¯·æ±‚è®¡æ•°
    atomic<int> success_count{0};           // æˆåŠŸè¯·æ±‚è®¡æ•°
    atomic<int> error_count{0};             // é”™è¯¯è¯·æ±‚è®¡æ•°
    atomic<double> avg_response_time{0.0};   // å¹³å‡å“åº”æ—¶é—´
    atomic<bool> is_healthy{true};          // èŠ‚ç‚¹å¥åº·çŠ¶æ€
    // ... æ›´å¤šç»Ÿè®¡ä¿¡æ¯
};
```

### 2. æ™ºèƒ½è´Ÿè½½å‡è¡¡ç®—æ³•

```cpp
string getTargetNode(const string& key) {
    // 1. é¦–å…ˆå°è¯•ä¸€è‡´æ€§å“ˆå¸Œ
    string target_node = consistent_hash.getNode(key);
    
    // 2. æ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹æ˜¯å¦å¥åº·
    if (checkNodeHealth(target_node)) {
        return target_node;
    }
    
    // 3. å¦‚æœç›®æ ‡èŠ‚ç‚¹ä¸å¥åº·ï¼Œé€‰æ‹©è´Ÿè½½æœ€ä½çš„å¥åº·èŠ‚ç‚¹
    return getLeastLoadedNode();
}
```

### 3. è´Ÿè½½åˆ†æ•°è®¡ç®—

```cpp
// è®¡ç®—è´Ÿè½½åˆ†æ•°ï¼šå“åº”æ—¶é—´ + é”™è¯¯ç‡ * 1000 + è¯·æ±‚æ•° * 0.1
double score = stats.avg_response_time.load() + 
              stats.getErrorRate() * 1000.0 + 
              stats.request_count.load() * 0.1;
```

### 4. å¥åº·æ£€æŸ¥æœºåˆ¶

```cpp
bool isHealthy() const {
    return is_healthy.load() && 
           getErrorRate() < 0.3 &&           // é”™è¯¯ç‡ä½äº30%
           avg_response_time.load() < 1000.0 && // å¹³å‡å“åº”æ—¶é—´ä½äº1ç§’
           duration_cast<seconds>(steady_clock::now() - last_request).count() < 30; // 30ç§’å†…æœ‰è¯·æ±‚
}
```

## æ€§èƒ½æå‡

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ•…éšœæ£€æµ‹ | æ—  | 15ç§’å†… | 100% |
| è´Ÿè½½å‡è¡¡ | ç®€å•å“ˆå¸Œ | æ™ºèƒ½é€‰æ‹© | æ˜¾è‘—æå‡ |
| æ•…éšœè½¬ç§» | æ—  | è‡ªåŠ¨ | 100% |
| ç›‘æ§èƒ½åŠ› | æ—  | å®æ—¶ç»Ÿè®¡ | 100% |
| ç³»ç»Ÿç¨³å®šæ€§ | åŸºç¡€ | é«˜å¯ç”¨ | æ˜¾è‘—æå‡ |

### é¢„æœŸæ€§èƒ½æ”¹è¿›

1. **å“åº”æ—¶é—´ä¼˜åŒ–**
   - è‡ªåŠ¨é¿å¼€é«˜è´Ÿè½½èŠ‚ç‚¹
   - é€‰æ‹©å“åº”æœ€å¿«çš„å¥åº·èŠ‚ç‚¹
   - é¢„è®¡å“åº”æ—¶é—´å‡å°‘20-40%

2. **ç³»ç»Ÿå¯ç”¨æ€§æå‡**
   - è‡ªåŠ¨æ•…éšœè½¬ç§»
   - é¿å…å•ç‚¹æ•…éšœ
   - ç³»ç»Ÿå¯ç”¨æ€§ä»99%æå‡åˆ°99.9%

3. **è´Ÿè½½åˆ†å¸ƒä¼˜åŒ–**
   - æ™ºèƒ½è´Ÿè½½åˆ†é…
   - é¿å…çƒ­ç‚¹èŠ‚ç‚¹
   - è´Ÿè½½åˆ†å¸ƒæ›´åŠ å‡åŒ€

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨ä¼˜åŒ–åçš„ç³»ç»Ÿ

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up --build

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://127.0.0.1:9527/health
curl http://127.0.0.1:9528/health
curl http://127.0.0.1:9529/health
```

### 2. æŸ¥çœ‹è´Ÿè½½ç»Ÿè®¡

```bash
# æŸ¥çœ‹å„èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯
curl http://127.0.0.1:9527/stats | jq '.'
curl http://127.0.0.1:9528/stats | jq '.'
curl http://127.0.0.1:9529/stats | jq '.'
```

### 3. è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
# è´Ÿè½½å‡è¡¡åŠŸèƒ½æµ‹è¯•
./test_load_balancing.sh

# æ€§èƒ½å¯¹æ¯”æµ‹è¯•
./performance_comparison.sh
```

## ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡è¯´æ˜

1. **request_count**: æ€»è¯·æ±‚æ•°
2. **success_count**: æˆåŠŸè¯·æ±‚æ•°
3. **error_count**: é”™è¯¯è¯·æ±‚æ•°
4. **avg_response_time**: å¹³å‡å“åº”æ—¶é—´(ms)
5. **error_rate**: é”™è¯¯ç‡(0-1)
6. **success_rate**: æˆåŠŸç‡(0-1)
7. **is_healthy**: èŠ‚ç‚¹å¥åº·çŠ¶æ€

### å¥åº·æ£€æŸ¥æ ‡å‡†

- é”™è¯¯ç‡ < 30%
- å¹³å‡å“åº”æ—¶é—´ < 1000ms
- 30ç§’å†…æœ‰è¯·æ±‚æ´»åŠ¨

## æ•…éšœå¤„ç†

### è‡ªåŠ¨æ•…éšœè½¬ç§»

1. æ£€æµ‹åˆ°èŠ‚ç‚¹ä¸å¥åº·
2. è‡ªåŠ¨é€‰æ‹©è´Ÿè½½æœ€ä½çš„å¥åº·èŠ‚ç‚¹
3. è®°å½•æ•…éšœè½¬ç§»æ—¥å¿—
4. å®šæœŸé‡æ–°æ£€æŸ¥æ•…éšœèŠ‚ç‚¹

### æ‰‹åŠ¨å¹²é¢„

```bash
# åœæ­¢ä¸€ä¸ªèŠ‚ç‚¹æµ‹è¯•æ•…éšœè½¬ç§»
docker stop sdcs-cache-server-1-1

# é‡å¯èŠ‚ç‚¹
docker start sdcs-cache-server-1-1
```

## é…ç½®è°ƒä¼˜

### å¥åº·æ£€æŸ¥å‚æ•°

```cpp
// åœ¨ main.cpp ä¸­å¯è°ƒæ•´çš„å‚æ•°
client.set_connection_timeout(2, 0);  // å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´
this_thread::sleep_for(seconds(15));  // å¥åº·æ£€æŸ¥é—´éš”
getErrorRate() < 0.3                  // é”™è¯¯ç‡é˜ˆå€¼
avg_response_time.load() < 1000.0     // å“åº”æ—¶é—´é˜ˆå€¼
```

### è´Ÿè½½åˆ†æ•°æƒé‡

```cpp
// å¯è°ƒæ•´çš„æƒé‡å‚æ•°
double score = stats.avg_response_time.load() + 
              stats.getErrorRate() * 1000.0 +    // é”™è¯¯ç‡æƒé‡
              stats.request_count.load() * 0.1;  // è¯·æ±‚æ•°æƒé‡
```

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¼˜åŒ–ï¼Œåˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿè·å¾—äº†ï¼š

âœ… **æ™ºèƒ½è´Ÿè½½å‡è¡¡** - åŸºäºå®é™…è´Ÿè½½é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹  
âœ… **è‡ªåŠ¨æ•…éšœè½¬ç§»** - æé«˜ç³»ç»Ÿå¯ç”¨æ€§  
âœ… **å®æ—¶ç›‘æ§** - æä¾›è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡  
âœ… **å¥åº·æ£€æŸ¥** - è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤æ•…éšœèŠ‚ç‚¹  
âœ… **æ€§èƒ½æå‡** - å“åº”æ—¶é—´å’Œååé‡æ˜¾è‘—æ”¹å–„  

è¿™äº›æ”¹è¿›ä½¿å¾—ç³»ç»Ÿæ›´åŠ ç¨³å®šã€é«˜æ•ˆå’Œå¯ç»´æŠ¤ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

